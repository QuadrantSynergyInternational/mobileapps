name: Build iOS IPA
on:
  workflow_dispatch:
    inputs:
      params:
        type: string
        description: Build Params
        required: true
jobs:
  init:
    runs-on: macOS-latest
    outputs: ${{ fromJSON(inputs.params) }}
    steps:
      - name: Parse Config Params
        run: echo "OK"
  build:
    needs: init
    runs-on: macOS-latest
    steps:
      - name: Setup Node.js environment
        uses: actions/setup-node@v4.0.4
        if: ${{ needs.init.outputs.node != '' }}
        with:
          node-version: ${{ needs.init.outputs.node }}
      - name: Clone Repo
        run: git clone --depth=1 --single-branch --branch=${{ needs.init.outputs.branch }} https://${{ secrets.GIT_USERNAME }}:${{ secrets.GIT_PASSWORD }}@${{ needs.init.outputs.repo }} input
      - name: Clone Provision
        run: git clone --depth=1 --single-branch --branch=main https://admindevopsqsi:${{ secrets.GH_PAT }}@https://github.com/admindevopsqsi/ios-provision.git provision
      - name: Yarn Install
        working-directory: input
        run: yarn install
      - name: Pod Repo
        run: pod repo add QuadrantSpecs https://oktapod.quadrant-si.id/framework/quadrant.specs.git
      - name: Pod install
        working-directory: input/ios
        run: pod install
      - name: Download Export Plist
        run: curl --output export.plist "https://appcenterq.vercel.app/ios-export"
      - name: Build IPA
        uses: muhamad-rizki/ios-build-action@v1.0.2
        with:
          p12-path: ./provision/${{ needs.init.outputs.projectid }}/${{ needs.init.outputs.branch }}.p12
          mobileprovision-path: ./provision/${{ needs.init.outputs.projectid }}/${{ needs.init.outputs.branch }}.mobileprovision
          code-signing-identity: 'iPhone Distribution'
          team-id: ${{ needs.init.outputs.teamid }}
          certificate-password: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          project-path: input/ios/${{ needs.init.outputs.projectpath }}
          workspace-path: input/ios/${{ needs.init.outputs.projectworkspace }}
          scheme: ${{ needs.init.outputs.scheme }}
          configuration: ${{ needs.init.outputs.configuration }}
          export-method: ${{ needs.init.outputs.exportmethod }}
          output-path: output-${{ needs.init.outputs.configuration }}.ipa
          export-options: export.plist
      - name: Upload to release
        uses: softprops/action-gh-release@v1
        with:
          repository: ${{ needs.init.outputs.releaseTo }}
          token: ${{ secrets.GH_PAT }}
          files: |
            output-${{ needs.init.outputs.configuration }}.ipa
            manifest.plist
          tag_name: "v${{ needs.init.outputs.tags }}-${{ needs.init.outputs.configuration }}"
          body: "IPA Release v${{ needs.init.outputs.tags }} (${{ needs.init.outputs.configuration }})"
          append_body: true
